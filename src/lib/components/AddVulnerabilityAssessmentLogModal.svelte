<script lang="ts">
	import { onMount } from 'svelte';
	import type { Building } from '@prisma/client';
	import { Button, CheckboxPanel, Input, Modal, ModalContext, NumberInput, SectionalForm, Select, TextArea } from '.';
	import { defaultInspectionScope, defaultVulnerabilityAssessmentLogData, selectBuilding, type AssessmentLogData, type VulnerabilityAssessmentLog } from '$lib/stores';
	import { BUILDING_CONDITION_FLAGS, BUILDING_DESIGN_CHANGE_TYPES, BUILDING_DISTRESS_TYPES, BUILDING_MATERIALS, getRiseCode, getVintage } from '$lib/helpers';
	import prettyMilliseconds from 'pretty-ms';

    export let building: Building;

    export let preview: VulnerabilityAssessmentLog | null = null;

    let log: Partial<AssessmentLogData> = { type: 'pre' };
    
    let modalContext: ModalContext;

    let inspectionScope = defaultInspectionScope;
    let data = defaultVulnerabilityAssessmentLogData;

    let designChangeYear = new Date().getFullYear();
    let designChangeType = '';
    let designChangeRemarks = '';

    let pastDistressYear = new Date().getFullYear();
    let pastDistressType = '';
    let pastDistressRemarks = '';

    let adjacencyFlags: Record<string, boolean> = {};
    let exteriorFallingHazardFlags: Record<string, boolean> = {};
    let verticalIrregularitiesFlags: Record<string, boolean> = {};
    let planIrregularitiesFlags: Record<string, boolean> = {};
    let columnDamagesFlags: Record<string, boolean> = {};
    let beamDamagesFlags: Record<string, boolean> = {};

    let formCompletionStart = new Date().getTime();

    const resetForm = () => {
        if (preview) {
            log = preview;
            inspectionScope = preview.inspectionScope;
            data = preview.inspectionData;

            const mapConditionFlags = (conditions: string[]) => {
                return conditions.reduce<Record<string, boolean>>((flags, x) => {
                    flags[x] = true;
                    return flags;
                }, {});
            }

            adjacencyFlags = mapConditionFlags(data.presentBuildingCondition.adjacency.conditions);
            exteriorFallingHazardFlags = mapConditionFlags(data.presentBuildingCondition.exteriorFallingHazard.conditions);
            verticalIrregularitiesFlags = mapConditionFlags(data.presentBuildingCondition.verticalIrregularities.conditions);
            planIrregularitiesFlags = mapConditionFlags(data.presentBuildingCondition.planIrregularities.conditions);
            columnDamagesFlags = mapConditionFlags(data.presentBuildingCondition.columnDamages.conditions);
            beamDamagesFlags = mapConditionFlags(data.presentBuildingCondition.beamDamages.conditions);
        } else {
            log = { type: 'pre' };
            inspectionScope = defaultInspectionScope;
            data = defaultVulnerabilityAssessmentLogData;

            designChangeYear = new Date().getFullYear();
            designChangeType = '';
            designChangeRemarks = '';

            pastDistressYear = new Date().getFullYear();
            pastDistressType = '';
            pastDistressRemarks = '';

            adjacencyFlags = {};
            exteriorFallingHazardFlags = {};
            verticalIrregularitiesFlags = {};
            planIrregularitiesFlags = {};
            columnDamagesFlags = {};
            beamDamagesFlags = {};

            formCompletionStart = new Date().getTime();
        }
    }

    onMount(() => {
        resetForm();
    });
    
    $: structuralTypes = data.buildingType.material in BUILDING_MATERIALS ? BUILDING_MATERIALS[data.buildingType.material].structuralTypes : {};
    $: data.buildingType.buildingTypeCode = data.buildingType.structuralType && data.general.storiesAboveGround > 0 ? data.buildingType.structuralType + '-' + getRiseCode(data.general.storiesAboveGround) : '';

    let error = '';
    let saving = false;

    const addVulnerabilityAssessmentLog = async () => {
        if (saving) return;
        saving = true;

        // update condition flags from bool stores
        const mapConditionFlags = (flags: Record<string, boolean>) => {
            return Object.entries(flags)
                .filter(([flag, enabled]) => enabled)
                .map(([flag, enabled]) => flag);
        }

        data.presentBuildingCondition.adjacency.conditions = mapConditionFlags(adjacencyFlags);
        data.presentBuildingCondition.exteriorFallingHazard.conditions = mapConditionFlags(exteriorFallingHazardFlags);
        data.presentBuildingCondition.verticalIrregularities.conditions = mapConditionFlags(verticalIrregularitiesFlags);
        data.presentBuildingCondition.planIrregularities.conditions = mapConditionFlags(planIrregularitiesFlags);
        data.presentBuildingCondition.columnDamages.conditions = mapConditionFlags(columnDamagesFlags);
        data.presentBuildingCondition.beamDamages.conditions = mapConditionFlags(beamDamagesFlags);


        // prep payload
        const payload: Partial<VulnerabilityAssessmentLog> = {
            ...log,
            formCompletionDuration: (new Date().getTime()) - formCompletionStart,
            inspectionScope,
            inspectionData: {
                ...data
            },
        };

        const response = await fetch(`/buildings/${building.id}/addVulnerabilityAssessmentLog`, {
            method: 'POST',
            body: JSON.stringify(payload),
        });

        const res = await response.json();

        if (response.ok) {
            resetForm();
            modalContext.modal.close();
            selectBuilding(building, true);
        } else {
            error = res.message || 'Failed to submit vulnerability assessment.';
        }

        saving = false;
    };

    const cancel = () => {
        if (preview || confirm('Are you sure you want to cancel this submission? All unsaved data will be lost.')) {
            resetForm();
            modalContext.modal.close();
        }
    }

    $: disabled = preview != null || saving;
</script>
<ModalContext bind:this={modalContext} let:modal actionRequired={preview == null}>
    <slot {modal}></slot>
    <Modal>
        <SectionalForm onSubmit={addVulnerabilityAssessmentLog}>
            <section>
                <aside>
                    <button type="button" class="cancel-button" on:click={cancel}>
                        <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 12L4 12M4 12L12 20M4 12L12 4" stroke="currentColor" stroke-linecap="square" stroke-width="2" />
                        </svg>
                        {preview == null ? 'Cancel' : 'Dismiss'}
                    </button>
                </aside>
                <main>
                    <h2>{building.name}</h2>
                    {#if preview}
                        <div class="subtitle">
                            <strong>{log.inspectionDate?.toDateString()}</strong>
                            <span>{prettyMilliseconds(log.formCompletionDuration || 0)}</span>
                        </div>
                    {/if}
                </main>
            </section>
            <section>
                <aside><h3>Inspection Log</h3></aside>
                <main>
                    <Input label="Inspector Name" bind:value={log.inspectorName} placeholder="Inspector Name" required {disabled} />
                    <div class="control-group">
                        <Input label="Affiliation" bind:value={log.inspectorAffiliation} placeholder="Affiliation" required {disabled} />
                        <Input label="Designation" bind:value={log.inspectorDesignation} placeholder="Designation" required {disabled} />
                    </div>

                    <h4>Extent of Review</h4>
                    <div class="control-group">
                        <Select label="Exterior" bind:value={inspectionScope.exterior} required {disabled}>
                            <option value="Partial">Partial</option>
                            <option value="All Sides">All Sides</option>
                            <option value="Aerial">Aerial</option>
                        </Select>
                        <Select label="Interior" bind:value={inspectionScope.interior} required {disabled}>
                            <option value="None">None</option>
                            <option value="Visible">Visible</option>
                            <option value="Entered">Entered</option>
                        </Select>
                    </div>

                    <h4>Drawings Reviewed</h4>
                    <div class="control-group">
                        <CheckboxPanel bind:checked={inspectionScope.drawings.structuralPlans} {disabled}>
                            Structural Plans
                        </CheckboxPanel>
                        <CheckboxPanel bind:checked={inspectionScope.drawings.architecturalPlans} {disabled}>
                            Architectural Plans
                        </CheckboxPanel>
                    </div>
                    <Input label="Other Drawings" bind:value={inspectionScope.drawings.other} placeholder="Leave blank if no other drawings reviewed." {disabled} />
                </main>
            </section>
            <section>
                <aside><h3>Building ID & General Information</h3></aside>
                <main>
                    <div class="control-group">
                        <NumberInput label="Year Built" bind:value={data.general.yearBuilt} required {disabled} />
                        <Input label="Vintage" value={data.general.yearBuilt ? getVintage(data.general.yearBuilt) : ''} disabled />
                    </div>
                    <div class="control-group">
                        <NumberInput label="Stories Above Ground" bind:value={data.general.storiesAboveGround} {disabled} />
                        <NumberInput label="Stories Below Ground" bind:value={data.general.storiesBelowGround} {disabled} />
                    </div>
                    <NumberInput label="Approx. Footprint Area (sqm)" bind:value={data.general.approxAreaPerFloor} {disabled} />
                    <div class="control-group">
                        <div style="width: 100%;">
                            <Select label="Est. No. of Occupants" bind:value={data.general.estimatedOccupants} required {disabled}>
                                <option value="0-10">0-10</option>
                                <option value="11-100">11-100</option>
                                <option value="101-1000">101-1000</option>
                                <option value="1000+">1000+</option>
                            </Select>
                        </div>
                        <div style="width: 100%;">
                            <Select label="Occupancy Category" bind:value={data.general.occupancyCategory} required {disabled}>
                                <option value="Essential Facility">Essential Facility</option>
                                <option value="Hazardous Facility">Hazardous Facility</option>
                                <option value="Special Occupancy">Special Occupancy</option>
                                <option value="Standard Occupancy">Standard Occupancy</option>
                                <option value="Miscellaneous Structure">Miscellaneous Structure</option>
                            </Select>
                            <ModalContext let:modal>
                                <!-- svelte-ignore a11y-invalid-attribute -->
                                <a class="link" style="margin-top: 0.5rem;" href="javascript:void(0)" on:click={modal.open}>Occupancy categories...</a>
                                <Modal context={modal} class="text-modal">
                                    <div class="prose">
                                        <h3>Occupancy Categories</h3>
                                        <h4>Essential Facility</h4>
                                        <ul>
                                            <li>Occupancies having surgery and emergency treatment areas</li>
                                            <li>Fire and police stations </li>
                                            <li>Garages and shelters for emergency vehicles and emergency aircraft</li>
                                            <li>Structures and shelters in emergency preparedness centers</li>
                                            <li>Aviation control towers</li>
                                            <li>Structures and equipment in communication centers and other facilities required for emergency response</li>
                                            <li>Facilities for standby power-generating equipment for Category I structures</li>
                                            <li>Tanks or other structures containing housing or supporting water or other fire-suppression material or equipment required for the protection of Category I, II or III structures</li>
                                            <li>Public school buildings</li>
                                            <li>Hospitals</li>
                                            <li>Designated evacuation centers</li>
                                        </ul>

                                        <h4>Hazardous Facility</h4>
                                        <ul>
                                            <li>Occupancies and structures housing or supporting toxic or explosive chemicals or substances</li>
                                            <li>Non-building structures storing, supporting or containing quantities of toxic or explosive substances</li>
                                        </ul>

                                        <h4>Special Occupancy</h4>
                                        <ul>
                                            <li>Single-story school buildings</li>
                                            <li>Buildings with an assembly room with an occupant capacity of 1,000 or more</li>
                                            <li>Educational buildings such as museums, libraries, auditorium with a capacity of 300 or more students</li>
                                            <li>Buildings used for college or adult education with a capacity of 500 or more students</li>
                                            <li>Institutional buildings with 50 or more incapacitated patients, but not included in Category I</li>
                                            <li>Mental hospitals, sanitariums, jails, prison and other buildings where personal liberties of inmates are similarly restrained</li>
                                            <li>All structures with an occupancy of 5,000 or more persons</li>
                                            <li>Structures and equipment in power-generating stations, and other public utility facilities not included in Category I or Category II, and required for continued operation.</li>
                                        </ul>

                                        <h4>Standard Occupancy</h4>
                                        <ul>
                                            <li>All structures housing occupancies or having functions not listed in Category I, II or II and Category V</li>
                                        </ul>

                                        <h4>Miscellaneous Structure</h4>
                                        <ul>
                                            <li>Private garages. carports, sheds and fences over 1.5m high</li>
                                        </ul>
                                    </div>

                                    <div class="button-group">
                                        <Button onClick={modal.close}>Dismiss</Button>
                                    </div>
                                </Modal>
                            </ModalContext>
                        </div>
                    </div>
                </main>
            </section>
            <section>
                <aside><h3>Building Type</h3></aside>
                <main>
                    <div class="control-group">
                        <Select label="Building Material" bind:value={data.buildingType.material} required {disabled} onChange={() => {
                            data.buildingType.structuralType = '';
                        }}>
                            <option value="" disabled>Building Material</option>
                            {#each Object.entries(BUILDING_MATERIALS) as [value, mat]}
                                <option {value}>{mat.name}</option>
                            {/each}
                        </Select>
                        <Select label="Structural Type" bind:value={data.buildingType.structuralType} required {disabled}>
                            <option value="" disabled>Structural Type</option>
                            {#each Object.entries(structuralTypes) as [value, text]}
                                <option {value}>{text}</option>
                            {/each}
                        </Select>
                        <Input label="Final Building Type" value={data.buildingType.buildingTypeCode} disabled />
                    </div>
                </main>
            </section>
            <section>
                <aside><h3>Building History</h3></aside>
                <main>
                    <h4 class="section-label">Design Changes</h4>

                    {#each data.buildingHistory.designChanges as row, i}
                        <div class="control-group">
                            <NumberInput label="Year" bind:value={row.year} disabled />
                            <Select label="Type" bind:value={row.type} disabled>
                                {#each Object.entries(BUILDING_DESIGN_CHANGE_TYPES) as [value, text]}
                                    <option {value}>{text}</option>
                                {/each}
                            </Select>
                            <Input label="Remarks" bind:value={row.remarks} disabled />
                            {#if preview == null}
                                <div class="button-group right">
                                    <Button secondary onClick={() => {
                                        data.buildingHistory.designChanges.splice(i, 1);
                                        data.buildingHistory.designChanges = [...data.buildingHistory.designChanges];
                                    }}>
                                        <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6.34326 6.34314L17.657 17.6568" stroke="currentColor" stroke-linecap="square"/>
                                            <path d="M17.6567 6.34314L6.34303 17.6568" stroke="currentColor" stroke-linecap="square"/>
                                        </svg>
                                    </Button>
                                </div>
                            {/if}
                        </div>
                    {/each}

                    {#if preview == null}
                        <div class="control-group">
                            <NumberInput label="Year" bind:value={designChangeYear} {disabled} />
                            <Select label="Type" bind:value={designChangeType} {disabled}>
                                {#each Object.entries(BUILDING_DESIGN_CHANGE_TYPES) as [value, text]}
                                    <option {value}>{text}</option>
                                {/each}
                            </Select>
                            <Input label="Remarks" bind:value={designChangeRemarks} {disabled} />
                            <div class="button-group right">
                                <Button disabled={!designChangeYear || !designChangeType || !designChangeRemarks} onClick={() => {
                                    data.buildingHistory.designChanges.push({ year: designChangeYear, type: designChangeType, remarks: designChangeRemarks });
                                    data.buildingHistory.designChanges = [...data.buildingHistory.designChanges];
        
                                    designChangeYear = new Date().getFullYear();
                                    designChangeType = '';
                                    designChangeRemarks = '';
                                }}>
                                    <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 12H20" stroke="currentColor" stroke-linecap="square"/>
                                        <path d="M12 4L12 20" stroke="currentColor" stroke-linecap="square"/>
                                    </svg>
                                </Button>
                            </div>
                        </div>
                    {/if}

                    <hr />

                    <h4 class="section-label">Past Distress</h4>

                    {#each data.buildingHistory.pastDistress as row, i}
                        <div class="control-group">
                            <NumberInput label="Year" bind:value={row.year} disabled />
                            <Select label="Type" bind:value={row.type} disabled>
                                {#each Object.entries(BUILDING_DISTRESS_TYPES) as [value, text]}
                                    <option {value}>{text}</option>
                                {/each}
                            </Select>
                            <Input label="Remarks" bind:value={row.remarks} disabled />
                            {#if preview == null}
                                <div class="button-group right">
                                    <Button secondary onClick={() => {
                                        data.buildingHistory.pastDistress.splice(i, 1);
                                        data.buildingHistory.pastDistress = [...data.buildingHistory.pastDistress];
                                    }}>
                                        <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M6.34326 6.34314L17.657 17.6568" stroke="currentColor" stroke-linecap="square"/>
                                            <path d="M17.6567 6.34314L6.34303 17.6568" stroke="currentColor" stroke-linecap="square"/>
                                        </svg>
                                    </Button>
                                </div>
                            {/if}
                        </div>
                    {/each}

                    {#if preview == null}
                        <div class="control-group">
                            <NumberInput label="Year" bind:value={pastDistressYear} {disabled} />
                            <Select label="Type" bind:value={pastDistressType} {disabled}>
                                {#each Object.entries(BUILDING_DISTRESS_TYPES) as [value, text]}
                                    <option {value}>{text}</option>
                                {/each}
                            </Select>
                            <Input label="Remarks" bind:value={pastDistressRemarks} {disabled} />
                            <div class="button-group right">
                                <Button disabled={!pastDistressYear || !pastDistressType || !pastDistressRemarks} onClick={() => {
                                    data.buildingHistory.pastDistress.push({ year: pastDistressYear, type: pastDistressType, remarks: pastDistressRemarks });
                                    data.buildingHistory.pastDistress = [...data.buildingHistory.pastDistress];
        
                                    pastDistressYear = new Date().getFullYear();
                                    pastDistressType = '';
                                    pastDistressRemarks = '';
                                }}>
                                    <svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M4 12H20" stroke="currentColor" stroke-linecap="square"/>
                                        <path d="M12 4L12 20" stroke="currentColor" stroke-linecap="square"/>
                                    </svg>
                                </Button>
                            </div>
                        </div>
                    {/if}
                </main>
            </section>
            <section>
                <aside><h3>Present Building Conditions</h3></aside>
                <main>
                    <div class="prose">
                        <h4>Adjacency: Pounding</h4>
                        <p class="form-hint">Pick all options that apply.</p>
                    </div>
                    <div class="checkbox-group">
                        {#each Object.entries(BUILDING_CONDITION_FLAGS.ADJACENCY) as [id, opt]}
                            <CheckboxPanel bind:checked={adjacencyFlags[id]} {disabled}>
                                <img src="/images/{opt.image}" alt={id} style="max-width: 16rem;" />
                                {opt.description}
                            </CheckboxPanel>
                        {/each}
                    </div>
                    <TextArea label="Remarks" bind:value={data.presentBuildingCondition.adjacency.remarks} placeholder="Additional details on adjacency/pounding..." {disabled} />

                    <hr />

                    <div class="prose">
                        <h4>Exterior Falling Hazards</h4>
                        <p class="form-hint">Pick all options that apply.</p>
                    </div>
                    <div class="checkbox-group">
                        {#each Object.entries(BUILDING_CONDITION_FLAGS.EXTERIOR_FALLING_HAZARDS) as [id, opt]}
                            <CheckboxPanel bind:checked={exteriorFallingHazardFlags[id]} {disabled}>
                                <strong>{opt}</strong>
                            </CheckboxPanel>
                        {/each}
                    </div>
                    <TextArea label="Remarks" bind:value={data.presentBuildingCondition.exteriorFallingHazard.remarks} placeholder="Additional details on exterior falling hazards..." {disabled} />

                    <hr />

                    <div class="prose">
                        <h4>Vertical Irregularities</h4>
                        <p class="form-hint">Pick all options that apply.</p>
                    </div>
                    <div class="checkbox-group">
                        {#each Object.entries(BUILDING_CONDITION_FLAGS.VERTICAL_IRREGULARITIES) as [id, opt]}
                            <CheckboxPanel bind:checked={verticalIrregularitiesFlags[id]} {disabled}>
                                <img src="/images/{opt.image}" alt={id} style="max-width: 8rem;" />
                                <strong>{opt.name}</strong>
                                {opt.description}
                            </CheckboxPanel>
                        {/each}
                    </div>
                    <TextArea label="Remarks" bind:value={data.presentBuildingCondition.verticalIrregularities.remarks} placeholder="Additional details on vertical irregularities..." {disabled} />

                    <hr />

                    <div class="prose">
                        <h4>Plan Irregularities</h4>
                        <p class="form-hint">Pick all options that apply.</p>
                    </div>
                    <div class="checkbox-group">
                        {#each Object.entries(BUILDING_CONDITION_FLAGS.PLAN_IRREGULARITIES) as [id, opt]}
                            <CheckboxPanel bind:checked={planIrregularitiesFlags[id]} {disabled}>
                                <img src="/images/{opt.image}" alt={id} style="max-width: 8rem;" />
                                <strong>{opt.name}</strong>
                                {opt.description}
                            </CheckboxPanel>
                        {/each}
                    </div>
                    <TextArea label="Remarks" bind:value={data.presentBuildingCondition.planIrregularities.remarks} placeholder="Additional details on plan irregularities..." {disabled} />

                    <hr />

                    <div class="prose">
                        <h4>Damage/Deterioration of Columns</h4>
                        <p class="form-hint">Pick all options that apply.</p>
                    </div>
                    <div class="checkbox-group">
                        {#each Object.entries(BUILDING_CONDITION_FLAGS.COLUMN_DAMAGES) as [id, opt]}
                            <CheckboxPanel bind:checked={columnDamagesFlags[id]} {disabled}>
                                <img src="/images/{opt.image}" alt={id} style="max-width: 8rem;" />
                                <strong>{opt.name}</strong>
                                {opt.description}
                            </CheckboxPanel>
                        {/each}
                    </div>
                    <TextArea label="Remarks" bind:value={data.presentBuildingCondition.columnDamages.remarks} placeholder="Additional details on column damages..." {disabled} />

                    <hr />

                    <div class="prose">
                        <h4>Damage/Deterioration of Beams</h4>
                        <p class="form-hint">Pick all options that apply.</p>
                    </div>
                    <div class="checkbox-group">
                        {#each Object.entries(BUILDING_CONDITION_FLAGS.BEAM_DAMAGES) as [id, opt]}
                            <CheckboxPanel bind:checked={beamDamagesFlags[id]} {disabled}>
                                <img src="/images/{opt.image}" alt={id} style="max-width: 8rem;" />
                                <strong>{opt.name}</strong>
                                {opt.description}
                            </CheckboxPanel>
                        {/each}
                    </div>
                    <TextArea label="Remarks" bind:value={data.presentBuildingCondition.beamDamages.remarks} placeholder="Additional details on beam damages..." {disabled} />
                </main>
            </section>
            <section>
                <aside><h3>Overall Present Condition</h3></aside>
                <main>
                    <h4>Please specify the overall condition of the building.</h4>
                    <Select label="Overall Condition" bind:value={data.overallPresentCondition} {disabled}>
                        <option value="Good">Good</option>
                        <option value="Average">Average</option>
                        <option value="Bad">Bad</option>
                    </Select>
                    <TextArea label="Other Comments" bind:value={data.generalRemarks} placeholder="Comments re: unusual conditions, existing damages, existing hazards..." {disabled} />
                </main>
            </section>
            <section>
                <aside><h3>Contact Details</h3></aside>
                <main>
                    <Input label="Contact person/s in-charge" bind:value={log.contactName} required {disabled} />
                    <div class="control-group">
                        <Input label="Contact number/s" bind:value={log.contactPhone} required {disabled} />
                        <Input label="Contact email" bind:value={log.contactEmail} required {disabled} />
                    </div>
                </main>
            </section>
            {#if preview == null}
                <section class="cta-row">
                    <aside>
                        <Button secondary onClick={cancel}>Cancel</Button>
                    </aside>
                    <main>
                        {#if error}
                            <div class="error">{error}</div>
                        {/if}
                        <Button type="submit" disabled={saving}>Submit Vulnerability Assessment</Button>
                    </main>
                </section>
            {:else}
                <section>
                    <aside></aside>
                    <main>
                        <div class="button-group right">
                            <Button onClick={cancel}>Dismiss</Button>
                        </div>
                    </main>
                </section>
            {/if}
        </SectionalForm>
    </Modal>
</ModalContext>

<style>
    .subtitle {
        margin: -0.5rem 0 0;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: center;
        justify-content: space-between;
        color: var(--theme-accent);
        opacity: 0.5;
    }

    .cancel-button {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin: -0.33rem 0;
        padding: 0.5rem 0.5rem;
        padding-right: 0.75rem;
        background: none;
        border: none;
        border-radius: 0.25rem;
        outline: none;
        color: var(--theme-accent);
        font-weight: 700;
        cursor: pointer;
    }

    .cancel-button .icon {
        width: 1rem;
        height: 1rem;
    }

    .cancel-button:hover,
    .cancel-button:focus {
        background: var(--theme-accent);
        color: white;
    }

    .error {
        color: var(--theme-error);
        font-weight: 700;
    }
</style>