import { error } from '@sveltejs/kit';
import { prisma } from '$lib/server';
import type { VulnerabilityAssessmentLog } from '$lib/stores/selectedBuilding.js';

export async function POST({ params, request }) {
    const id = parseInt(params.id);
    if (isNaN(id)) throw error(400, 'Invalid building ID.');

    const building = await prisma.building.findFirst({ where: { id } });
    if (!building) throw error(400, 'Building not found.');

    const data: Partial<VulnerabilityAssessmentLog> = await request.json();

    // validate generic assessment log data
    if (!data.inspectorName) throw error(400, 'Please specify inspector name.');
    if (!data.inspectorAffiliation || !data.inspectorDesignation) throw error(400, 'Please specify inspector affiliation and designation.');    
    if (!data.inspectionScope?.exterior || !data.inspectionScope?.interior) throw error(400, 'Please specify inspection scopes (exterior/interior extents of review).');
    if (!data.contactName || !data.contactPhone || !data.contactEmail) throw error(400, 'Please specify complete contact details.');

    // validate vuln. assessment log fields
    if (!data.inspectionData) throw error(400, 'Invalid inspection data.');
    const v = data.inspectionData;

    if (!v.general.yearBuilt || v.general.yearBuilt < 1000 || v.general.yearBuilt > 3000) throw error(400, 'Invalid value for Year Built.');
    if (v.general.storiesAboveGround < 0 || v.general.storiesBelowGround < 0) throw error(400, 'Please double check values for stories above/below ground.');
    if (v.general.approxAreaPerFloor <= 0) throw error(400, 'Please provide approximate footprint area.');
    if (!v.general.estimatedOccupants || !v.general.occupancyCategory) throw error(400, 'Please specify estimated occupancy & category.');

    if (!v.buildingType.material || !v.buildingType.structuralType || !v.buildingType.buildingTypeCode) throw error(400, 'Please specify building type.');

    if (!v.overallPresentCondition) throw error(400, 'Please specify overall building condition.');


    try {
        const log = await prisma.assessmentLog.create({
            data: {
                buildingId: building.id,
                type: 'pre',

                inspectionDate: new Date(),
                inspectorName: data.inspectorName,
                inspectorAffiliation: data.inspectorAffiliation,
                inspectorDesignation: data.inspectorDesignation,

                inspectionScope: JSON.stringify(data.inspectionScope, null, 2),
                inspectionData: JSON.stringify(v, null, 2),

                contactName: data.contactName,
                contactPhone: data.contactPhone,
                contactEmail: data.contactEmail,

                formCompletionDuration: data.formCompletionDuration || 0,
            }
        });
        return new Response(JSON.stringify(log), {
            headers: {
                'Content-Type': 'application/json'
            }
        });
    } catch(err) {
        if (err instanceof Error) throw error(400, err.message);
        throw error(400, 'Failed to submit vulnerability assessment data.');
    }
}
